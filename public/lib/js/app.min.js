!function(){"use strict";angular.module("questCreator",["ui.router","LocalStorageModule"]).config(function(a,b){b.otherwise("/"),a.state("main",{abstract:!0,url:"/",templateUrl:"./src/views/main.html",controller:"mainCtrl as main"}).state("main.landing",{url:"",templateUrl:"./src/views/landing.html",controller:"landingCtrl as landing"}).state("main.game",{url:"game",templateUrl:"./src/views/game.html",controller:"gameCtrl as game"}).state("main.game.detail",{url:"/detail",templateUrl:"./src/views/game/detail.html",controller:"detailCtrl as detail"}).state("main.game.play",{url:"/play",templateUrl:"./src/views/game/play.html",controller:"playCtrl as play"}).state("main.game.editor",{abstract:!0,url:"/editor",templateUrl:"./src/views/game/editor.html",controller:"editorCtrl as editor"}).state("main.game.editor.views",{url:"/",views:{palette:{templateUrl:"./src/views/game/editor/palette.html",controller:"paletteCtrl as palette"},maps:{templateUrl:"./src/views/game/editor/map.html",controller:"mapCtrl as map"},scenes:{templateUrl:"./src/views/game/editor/scene.html",controller:"sceneCtrl as scene"},backgrounds:{templateUrl:"./src/views/game/editor/bg.html",controller:"bgCtrl as bg"},objects:{templateUrl:"./src/views/game/editor/obj.html",controller:"objCtrl as obj"},entities:{templateUrl:"./src/views/game/editor/ent.html",controller:"entCtrl as ent"},events:{templateUrl:"./src/views/game/editor/events.html",controller:"eventsCtrl as events"}}}).state("main.profile",{url:"profile",templateUrl:"./src/views/profile.html",controller:"profileCtrl as profile"})})}(),angular.module("questCreator").filter("capitalize",function(){return function(a){return a=a||"",a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}}),angular.module("questCreator").filter("nospace",function(){return function(a){return a?a.replace(/ /g,""):""}}),angular.module("questCreator").factory("Avatar",function(){function a(a){this.name=a.name,this.info=a.info,this.user_id=a.user_id,this.action="stand",this.info.speed={mag:3,x:0,y:0},this.info.currentFrameIndex=0,this.info.currentFrame=this.info.animate.walkDown[this.info.currentFrameIndex],this.animateDelay=10,this.animateTime=0,this.scale=1}return a.prototype.updatePos=function(){this.info.pos.x+=this.info.speed.x,this.info.pos.y+=this.info.speed.y},a.prototype.checkAction=function(){var a=this;if("stand"===a.action||"walkLeft"===a.action||"walkUp"===a.action||"walkRight"===a.action||"walkDown"===a.action){switch(a.action){case"stand":a.info.speed.x=0,a.info.speed.y=0;break;case"walkLeft":a.info.speed.x=-a.info.speed.mag,a.info.speed.y=0;break;case"walkUp":a.info.speed.x=0,a.info.speed.y=-a.info.speed.mag;break;case"walkRight":a.info.speed.x=a.info.speed.mag,a.info.speed.y=0;break;case"walkDown":a.info.speed.x=0,a.info.speed.y=a.info.speed.mag}a.animateTime>a.animateDelay&&("stand"!==a.action&&(a.info.currentFrame=a.info.animate[a.action][a.info.currentFrameIndex],a.info.currentFrameIndex++,a.info.currentFrameIndex>a.info.animate[a.action].length-1&&(a.info.currentFrameIndex=0)),a.animateTime=0),a.animateTime++}},a.prototype.stop=function(){this.action="stand",this.info.speed.x=0,this.info.speed.y=0},a.prototype.collide=function(a){switch(this.stop(),a){case"left":this.info.pos.x+=this.info.speed.mag;break;case"right":this.info.pos.x-=this.info.speed.mag;break;case"up":this.info.pos.y+=this.info.speed.mag;break;case"down":this.info.pos.y-=this.info.speed.mag}},a}),angular.module("questCreator").factory("Background",function(){function a(a){this.name=a.name,this.obj=a.obj,this.game_id=a.game_id}return a}),angular.module("questCreator").factory("Entity",function(){function a(a){this.name=a.name,this.game_id=a.game_id,this.action="walkLeft",this.info=a.info,this.info.speed={mag:3,x:0,y:0},this.info.currentFrameIndex=0,this.info.currentFrame=this.info.animate[this.action][this.info.currentFrameIndex],this.animateDelay=20,this.animateTime=0,this.scale=1}return a.prototype.updatePos=function(){this.info.pos.x+=this.info.speed.x,this.info.pos.y+=this.info.speed.y},a.prototype.checkAction=function(){var a=this;if(a.animateTime>a.animateDelay){if("stand"===a.action||"walkLeft"===a.action||"walkUp"===a.action||"walkRight"===a.action||"walkDown"===a.action){switch(a.action){case"walkLeft":a.info.speed.x=-a.info.speed.mag,a.info.speed.y=0;break;case"walkUp":a.info.speed.x=0,a.info.speed.y=-a.info.speed.mag;break;case"walkRight":a.info.speed.x=a.info.speed.mag,a.info.speed.y=0;break;case"walkDown":a.info.speed.x=0,a.info.speed.y=a.info.speed.mag}a.info.currentFrame=a.info.animate[a.action][a.info.currentFrameIndex],a.info.currentFrameIndex++,a.info.currentFrameIndex>a.info.animate[a.action].length-1&&(a.info.currentFrameIndex=0)}a.animateTime=0}a.animateTime++},a.prototype.stop=function(){this.action="walkRight",this.info.speed.x=0,this.info.speed.y=0},a.prototype.wander=function(){this.info.speed.x=0,this.info.speed.y=0;var a=Math.floor(4*Math.random());switch(a){case 0:this.action="walkLeft";break;case 1:this.action="walkRight";break;case 2:this.action="walkUp";break;case 3:this.action="walkDown"}},a.prototype.collide=function(a){switch(this.wander(),a){case"left":this.info.pos.x+=this.info.speed.mag;break;case"right":this.info.pos.x-=this.info.speed.mag;break;case"up":this.info.pos.y+=this.info.speed.mag;break;case"down":this.info.pos.y-=this.info.speed.mag}},a}),angular.module("questCreator").factory("Game",function(){function a(a){this.name=a,this.maps=[],this.scenes=[],this.backgrounds=[],this.sceneObjects=[],this.entities=[]}return a}),angular.module("questCreator").factory("Map",function(){function a(a){this.name=a,this.scenes=[]}return a}),angular.module("questCreator").factory("PopupFactory",function(a,b){function c(b,c,d){var e=$("<popup>").attr({"popup-title":'"'+c+'"'}).append(b);e=a(e)(d),$(e).prependTo("body")}return{new:c}}),angular.module("questCreator").factory("Scene",function(){function a(a){this.name=a,this.backgrounds=[],this.sceneObjects=[],this.entities=[]}return a}),angular.module("questCreator").factory("SceneObject",function(){function a(a){this.name=a.name,this.obj=a.obj,this.game_id=a.game_id,this.action="none",this.allActions=[]}return a}),angular.module("questCreator").directive("blurOnEnter",function(){return{terminal:!0,link:function(a,b,c){b.bind("keyup",function(a){13===a.which&&b.blur()})}}}),angular.module("questCreator").directive("elastic",["$document","$window",function(a,b){function c(a,b){var c="";if(window.getComputedStyle)c=getComputedStyle(a).getPropertyValue(b);else if(a.currentStyle)try{c=a.currentStyle[b]}catch(a){}return c}function d(a){var b,d=a[0];do d=d.parentNode,b=parseInt(c(d,"width"),10)-parseInt(c(d,"padding-left"),10)-parseInt(c(d,"padding-right"),10);while("block"!=c(d,"display")&&"body"!=d.nodeName.toLowerCase());return b+"px"}function e(a,c,e){var f=b.getComputedStyle(c[0]),g="none"===f.maxWidth?d(c):f.maxWidth;c.css("minWidth",e.puElasticInputMinwidth||f.minWidth),c.css("maxWidth",e.puElasticInputMaxwidth||g),angular.forEach(["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing"],function(b){a.css(b,f[b])}),a.css("paddingLeft",f.textIndent),"border-box"===f.boxSizing?angular.forEach(["paddingLeft","paddingRight","borderLeftStyle","borderLeftWidth","borderRightStyle","borderRightWidth"],function(b){a.css(b,f[b])}):"padding-box"===f.boxSizing&&angular.forEach(["paddingLeft","paddingRight"],function(b){a.css(b,f[b])})}var f=angular.element('<div style="position:fixed; top:-999px; left:0;"></div>');return angular.element(a[0].body).append(f),{restrict:"A",link:function(a,b,c){function d(){var a=b.val()||c.placeholder||"";if(g.text()!=a){g.text(a);var d=parseInt(c.puElasticInputWidthDelta)||1;b.css("width",g.prop("offsetWidth")+d+"px")}}c.$set("ngTrim","true"===c.ngTrim?"true":"false");var g=angular.element('<span style="white-space:pre;">&#000;</span>');e(g,b,c),f.append(g),d(),a.$watch(c.ngModel,d),b.on("keydown keyup focus input propertychange change",d),a.$on("$destroy",function(){g.remove()})}}}]),angular.module("questCreator").directive("focus",["$timeout","$parse",function(a,b){return{link:function(c,d,e){var f=b(e.focus);c.$watch(f,function(b){b===!0&&a(function(){d[0].focus()})})}}}]),angular.module("questCreator").directive("popup",function(){return{scope:{title:"=popupTitle",kill:"@"},replace:!0,transclude:!0,link:function(a,b,c){a.kill=function(){$("#overlay").remove()}},templateUrl:"./src/views/popup.html",controller:function(a){a.killPopUp=function(){a.kill()}}}}),angular.module("questCreator").service("EditorService",function(a,b,c){function d(a,b){u={image:a,collision:b}}function e(a){return"image"===a?u.image:"collision"===a?u.collision:void 0}function f(a){var b={name:a.toLowerCase()};return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/games/load",data:b,success:function(a){return a},error:function(a){c.open("fail-game-load")}})}function g(b){var c={user_id:a.get().id,token:a.get().token},d={game_id:b};return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/articles/game/all",headers:c,data:d,success:function(a){return a},error:function(a){console.log(a)}})}function h(d){var e={user_id:a.get().id,token:a.get().token},f={name:"Title Screen",pos:[0,0,0],background:null,objects:[],entities:[],events:[]},g={name:"Title Map",scenes:[[f]]},h={name:d,description:"",tags:[],info:{maps:[g]}};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/games/create",data:JSON.stringify(h),headers:e,dataType:"json",contentType:"application/json",success:function(a){return h=a,k("Title Screen",h.id),i(h.id).done(function(a){console.log(a)}),h},error:function(a){c.openTemp("fail-game-create"),b.go("main.landing")}})}function i(b){var c={user_id:a.get().id,token:a.get().token},d={game_id:b};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/collaborators/self",headers:c,data:d,success:function(a){return a},error:function(a){console.log(a)}})}function j(b){var c={name:b.name,id:b.id,tags:b.tags,description:b.description,info:b.info,published:b.published||!1,thumbnail:b.info.maps[0].scenes[0][0].background.thumbnail},d=angular.copy(c);d.info.maps.forEach(function(a){a.scenes.forEach(function(a){a.forEach(function(a){a.background&&(a.background.thumbnail=null,a.background.info=null),a.entities&&a.entities.forEach(function(a){a.thumbnail=null,a.info.animate=null}),a.objects&&a.objects.forEach(function(a){a.thumbnail=null,a.info.collisionMap=null,a.info.image=null})})})}),console.log("Game Save Object",d);var e={user_id:a.get().id,token:a.get().token};return $.ajax({method:"PUT",url:"https://forge-api.herokuapp.com/games/update",headers:e,data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function k(b,c,d,e){var f={user_id:a.get().id,token:a.get().token},g=d||{image:[],collisionMap:[]},h={thumbnail:e||null,name:b,info:g,tags:[],published:!0,game_id:c};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/backgrounds/create",headers:f,data:JSON.stringify(h),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function l(b,c,d,e){d.info.image=b,d.info.collisionMap=c,d.thumbnail=e;var f={user_id:a.get().id,token:a.get().token};return $.ajax({method:"PUT",url:"https://forge-api.herokuapp.com/backgrounds/update",headers:f,data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function m(b,c,d){var e={user_id:a.get().id,token:a.get().token},f=d||{pos:{x:350,y:250},image:[],collisionMap:[]},g={name:b,info:f,tags:[],published:!1,game_id:c};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/obstacles/create",headers:e,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function n(b,c,d,e){d.info.image=b,d.info.collisionMap=c,d.thumbnail=e;var f={user_id:a.get().id,token:a.get().token};return $.ajax({method:"PUT",url:"https://forge-api.herokuapp.com/obstacles/update",headers:f,data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function o(b,c,d){var e={user_id:a.get().id,token:a.get().token},f=d||{pos:{x:350,y:250},animate:{walkLeft:[{image:[],collisionMap:[]},{image:[],collisionMap:[]},{image:[],collisionMap:[]}],walkRight:[{image:[],collisionMap:[]},{image:[],collisionMap:[]},{image:[],collisionMap:[]}],walkUp:[{image:[],collisionMap:[]},{image:[],collisionMap:[]},{image:[],collisionMap:[]}],walkDown:[{image:[],collisionMap:[]},{image:[],collisionMap:[]},{image:[],collisionMap:[]}]}},g={name:b,info:f,tags:[],published:!1,game_id:c};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/entities/create",headers:e,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function p(b,c,d,e,f,g){d.info.animate[e][f].image=b,d.info.animate[e][f].collisionMap=c,d.thumbnail=g,d.published=!0;var h={user_id:a.get().id,token:a.get().token};return $.ajax({method:"PUT",url:"https://forge-api.herokuapp.com/entities/update",headers:h,data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function q(a){return $.ajax({method:"DELETE",url:"https://forge-api.herokuapp.com/entities/delete",headers:headerData,data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function r(b,c,d){var e={user_id:a.get().id,token:a.get().token},f={requirements:[],triggers:[],results:{text:[],achievements:[],inventory:[],portal:{}}},g={name:b,category:c,info:f,tags:[],published:!1,game_id:d};return $.ajax({method:"POST",url:"https://forge-api.herokuapp.com/events/create",headers:e,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a){return console.log(a),a},error:function(a){console.log(a)}})}function s(b){var c={id:b.id,info:b.info,game_id:b.game_id,published:b.published,name:b.name,tags:b.tags,category:b.category};console.log(c);var d={user_id:a.get().id,token:a.get().token};return $.ajax({method:"PUT",url:"https://forge-api.herokuapp.com/events/update",headers:d,data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a){return console.log(a),a},error:function(a){console.log(a)}})}function t(b,c){"objects"===c&&(c="obstacles");var d={user_id:a.get().id,token:a.get().token};return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/"+c+"/select",headers:d,data:{id:b},success:function(a){return a},error:function(a){console.log(a)}})}var u={image:[],collision:[]};return{getGame:f,getGameAssets:g,getAssetInfo:t,createGame:h,saveGame:j,createBackground:k,saveBackground:l,createObject:m,saveObject:n,createEntity:o,saveEntity:p,deleteEntity:q,createEvent:r,saveEvent:s,copy:d,paste:e}}),angular.module("questCreator").service("GameService",function(a){function b(b){var c={name:b.toLowerCase()};return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/games/load",data:c,success:function(a){return a},error:function(b){a.open("fail-game-load")}})}function c(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/games/all",contentType:"application/json",success:function(a){return a},error:function(b){a.openTemp("fail-games-load")}})}function d(){return g}function e(a){g=a}function f(b){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/games/search",data:{name:b},success:function(a){return a},error:function(b){a.openTemp("fail-games-load")}})}var g={};return{loadGame:b,getGameDetail:d,setGameDetail:e,getGames:c,searchGames:f}}),angular.module("questCreator").service("StorageService",function(a){function b(b){var c=a.get("savedGames")||[],d=c[b];return console.log("All saved games",c),console.log("Your saved games for "+b,d),d}function c(b,c){var d=a.get("savedGames")||[];d[b]=c,console.log("New saved games list",d),a.set("savedGames",d)}function d(){return console.log("Checking for old game"),a.get("currentPlaying")||null}function e(b){console.log("Currently playing: "+b),a.set("currentPlaying",b)}return{getSavedGames:b,setSavedGames:c,getPlayingGame:d,setPlayingGame:e}}),angular.module("questCreator").service("PaletteService",function(a,b){function c(){return i}function d(){return h}function e(){$.ajax({method:"GET",url:"https://forge-api.herokuapp.com/articles/index",contentType:"application/json",success:function(a){return a},error:function(a){b.openTemp("fail-assets-load")}})}function f(a){return h=a,$.ajax({method:"GET",url:"https://forge-api.herokuapp.com/"+a+"/all",headers:j,success:function(a){return i=a},error:function(a){b.openTemp("fail-assets-load")}})}function g(a){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/"+h+"/search",headers:j,data:{name:a},success:function(a){return i=a},error:function(a){b.openTemp("fail-assets-load")}})}var h="",i=null,j={user_id:a.get().id,token:a.get().token};return{getCurrent:c,getCurrentType:d,getAll:e,getByType:f,getByTag:g}}),angular.module("questCreator").service("PopupService",function(a,b,c){function d(a,d){d=d||c.$$childHead;var e=g+h[a].content,f=$("<ng-include>").attr("src","'"+e+"'");c.$$childHead.popupTemp=!1,b.new(f,h[a].title,d)}function e(a,d){d=d||c.$$childHead;var e=g+h[a].content,i=$("<ng-include>").attr("src","'"+e+"'");c.$$childHead.popupTemp=!0,b.new(i,h[a].title,d),setTimeout(function(){f()},1500)}function f(){$("#overlay").remove()}var g="./src/views/popups/",h={welcome:{title:"Welcome!",content:"welcome.html"},"user-register":{title:"Hey, you're new!",content:"user-register.html"},"edit-username":{title:"Change your name:",content:"edit-username.html"},"edit-game":{title:"Awesome! Now you're editing:",content:"edit-game.html"},"create-game":{title:"Name your game:",content:"create-game.html"},"signin-to-continue":{title:"Please...",content:"signin-to-continue.html"},"loading-screen":{title:"Loading...",content:"loading-screen.html"},"fail-user-load":{title:"Oops!",content:"fail-user-load.html"},"fail-user-games":{title:"Oops!",content:"fail-user-games.html"},"fail-collab-load":{title:"Oops!",content:"fail-collab-load.html"},"fail-game-load":{title:"Oops!",content:"fail-game-load.html"},"fail-games-load":{title:"Oops!",content:"fail-games-load.html"},"fail-game-create":{title:"Oops!",content:"fail-game-create.html"},"fail-request-collab":{title:"Oops!",content:"fail-request-collab.html"},"fail-assets-load":{title:"Oops!",content:"fail-assets-load.html"},"fail-game-archive":{title:"Oops!",content:"fail-game-archive.html"},"alert-request-sent":{title:"Delivered:",content:"alert-request-sent.html"},"alert-request-resent":{title:"Delivered:",content:"alert-request-resent.html"},"alert-already-requested":{title:"Chill:",content:"alert-already-requested.html"},"alert-already-collab":{title:"Wait a minute...",content:"alert-already-collab.html"},"alert-game-archived":{title:"Done",content:"alert-game-archived.html"},"event-prompt":{title:"Choose event type:",content:"event-prompt.html"}};return{open:d,openTemp:e,close:f}}),angular.module("questCreator").service("socket",function(){var a=io();return{on:function(b,c){a.on(b,c)},emit:function(b,c){a.emit(b,c)},off:function(b,c){a.off(b,c)}}}),angular.module("questCreator").service("UserService",function(a,b){function c(){return new Promise(function(a,b){var c=setInterval(function(){F&&(a(!0),clearInterval(c))},20)})}function d(){return E}function e(a){E=a}function f(a){E.editGame=a}function g(){return E.editGame||null}function h(b){return $.ajax({method:"DELETE",url:"https://forge-api.herokuapp.com/games/archive",data:{id:b},headers:{user_id:E.id,token:E.token},success:function(b){a.openTemp("alert-game-archived")},error:function(b){a.openTemp("fail-game-archive")}})}function i(){gapi.client.setApiKey(C),gapi.auth2.init({client_id:D,scope:"profile"}).then(function(){B=gapi.auth2.getAuthInstance(),B.isSignedIn.listen(j),j(B.isSignedIn.get())})}function j(a){a?(b.$$childHead.main.loggedIn=!0,m()):b.$$childHead.main.loggedIn=!1}function k(){B.signIn({prompt:"login"})}function l(){B.signOut()}function m(){var b=gapi.client.request({path:"https://people.googleapis.com/v1/people/me",method:"GET"});b.then(function(b){E.picture=b.result.photos[0].url,E.uid=B.currentUser.Ab.El,E.token=B.currentUser.Ab.Zi.access_token,$.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/users/login",data:{uid:E.uid,token:E.token},success:function(b){E.joined=b.created_at,E.username=b.username,E.id=b.id,setTimeout(function(){a.openTemp("welcome")},500),F=!0},error:function(b){404===b.status?a.open("user-register"):0===b.status||(a.openTemp("fail-user-load"),l())}})})}function n(b){E.username=b,$.ajax({method:"POST",url:"https://forge-api.herokuapp.com/users/create",data:{username:E.username,uid:E.uid,token:E.token},success:function(b){E.id=b.id,a.open("user-register")},error:function(b){a.openTemp("fail-user-load"),l()}})}function o(a){return console.log(a),E.username=a,$.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/users/update",headers:{user_id:E.id,token:E.token},data:{username:a},success:function(a){return a},error:function(a){}})}function p(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/games/user-games",headers:{user_id:E.id,token:E.token},success:function(a){return a},error:function(b){a.openTemp("fail-user-games")}})}function q(a){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/collaborators/existence",headers:{user_id:E.id,token:E.token},data:{game_id:a},dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){return a}})}function r(a){$.ajax({method:"POST",url:"https://forge-api.herokuapp.com/collaborators/create",headers:{user_id:E.id,token:E.token},data:{game_id:a},success:function(a){},error:function(a){console.log(a)}})}function s(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/collaborators/user/requesters",headers:{user_id:E.id,token:E.token},success:function(a){},error:function(b){a.openTemp("fail-collab-load")}})}function t(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/collaborators/user/collaborators",headers:{user_id:E.id,token:E.token},dataType:"json",contentType:"application/json",success:function(a){},error:function(b){a.openTemp("fail-collab-load")}})}function u(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/users/collaborations",headers:{user_id:E.id,token:E.token},dataType:"json",contentType:"application/json",success:function(a){},error:function(b){a.openTemp("fail-collab-load")}})}function v(a,b){return $.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/collaborators/update/accepted",headers:{user_id:E.id,token:E.token},data:{game_id:a,requester_id:b},success:function(a){},error:function(a){console.log(a)}})}function w(a,b){return console.log(a,b),$.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/collaborators/update/requested",headers:{user_id:E.id,token:E.token},data:{game_id:a,requester_id:b},success:function(a){},error:function(a){console.log(a)}})}function x(a){$.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/collaborators/rerequest",headers:{user_id:E.id,token:E.token},data:{game_id:a},dataType:"json",contentType:"application/json",success:function(a){},error:function(a){console.log(a)}})}function y(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/users/avatar",headers:{user_id:E.id,token:E.token},dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function z(){return $.ajax({method:"GET",url:"https://forge-api.herokuapp.com/entities/user",headers:{user_id:E.id,token:E.token},dataType:"json",contentType:"application/json",success:function(a){return a},error:function(a){console.log(a)}})}function A(a,b){console.log(a,b),$.ajax({method:"PATCH",url:"https://forge-api.herokuapp.com/entities/make-current",headers:{user_id:E.id,token:E.token},data:{current:a,id:b},success:function(a){return a},error:function(a){console.log(a)}})}var B,C="AIzaSyCe__2EGSmwp0DR-qKGqpYwawfmRsTLBEs",D="730683845367-tjrrmvelul60250evn5i74uka4ustuln.apps.googleusercontent.com",E={uid:null,token:null,username:null,picture:null,id:null,games:null,joined:null,editGame:null},F=!1;return gapi.load("client:auth2",i),{get:d,set:e,setGameEdit:f,getGameEdit:g,getUserGames:p,validateCollabRequest:q,sendCollabRequest:r,getCollabRequests:s,getCollaborators:t,getCollaborations:u,toggleAccepted:v,toggleRequested:w,requestAgain:x,getAvatars:z,updateAvatar:A,getPlayerAvatar:y,archive:h,register:n,editUsername:o,signOut:l,signIn:k,checkLogin:c}}),angular.module("questCreator").controller("bgCtrl",function(a,b,c){function d(a,b,c,d,e,f){this.x=a,this.y=b,this.width=c,this.height=d,this.color=e,this.type=f}function e(a){o=!0}function f(a){o=!1}function g(){for(var a=0;a<k.allBackgroundSquares.length;a++){var b=k.allBackgroundSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function h(){for(var a=0;a<k.allCollisionSquares.length;a++){var b=k.allCollisionSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function i(){var a=b.editor.currentPixelSize;k.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top};var c=50,e=50,f=x/c,j=y/e,p=b.editor.drawingCollision?"rgba(100, 100, 100, 0.5)":b.editor.currentColor,q=b.editor.drawingCollision?"collision":"normal";k.draw.clearRect(0,0,x,y);for(var r=0;r<=x;r+=f)k.draw.moveTo(r,0),k.draw.lineTo(r,y);for(var r=0;r<=y;r+=j)k.draw.moveTo(0,r),k.draw.lineTo(x,r);k.draw.strokeStyle="rgba(200, 200, 200, 0.5)",k.draw.stroke(),g(),h(),k.draw.fillStyle=p;for(var s=-a;s<=a;s++)for(var t=-a;t<=a;t++){var u=Math.floor((m-k.canvasPos.x)/f+s)*f,v=Math.floor((n-k.canvasPos.y)/j+t)*j;if(b.editor.erasing?(k.draw.strokeStyle="black",k.draw.strokeRect(u,v,f,j)):k.draw.fillRect(u,v,f,j),o)if(b.editor.drawingCollision){if(b.editor.drawingCollision){var w=[];k.allCollisionSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allCollisionSquares.indexOf(a))}),w.forEach(function(a){k.allCollisionSquares.splice(a,1)})}}else{var w=[];k.allBackgroundSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allBackgroundSquares.indexOf(a))}),w.forEach(function(a){k.allBackgroundSquares.splice(a,1)})}if(o&&!b.editor.erasing){var z=new d(u,v,f,j,p,q);b.editor.drawingCollision?k.allCollisionSquares.push(z):k.allBackgroundSquares.push(z)}}l?requestAnimationFrame(i):(k.draw.clearRect(0,0,x,y),g())}var j,k=this,l=!1,m=null,n=null,o=!1,p=850,q=1100,r=1.4,s=2.5,t=1.6,u="",v=[],w=[];this.currentColor=b.editor.currentColor,this.myCanvas=document.getElementById("bg-canvas"),this.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top},this.draw=this.myCanvas.getContext("2d");var x=k.myCanvas.width,y=k.myCanvas.height;this.allCollisionSquares=[],this.allBackgroundSquares=[],d.prototype.draw=function(){k.draw.fillStyle=this.color,window.innerWidth<=p?k.draw.fillRect(this.x*s,this.y*t,this.width,this.height):window.innerWidth<=q?k.draw.fillRect(this.x*r,this.y/r,this.width,this.height):k.draw.fillRect(this.x,this.y,this.width,this.height)},b.$on("redrawBackground",function(a,c,d){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[];k.allBackgroundSquares=c,k.allCollisionSquares=d,g(),h();var e=k.myCanvas.toDataURL();b.editor.currentSceneImg={background:'url("'+e+'")'}}),$("#tool-bar").on("click","#undoBackground",function(){if(!b.editor.drawingCollision&&k.allBackgroundSquares.length>0){var a=k.allBackgroundSquares.pop();v.push(a)}else if(b.editor.drawingCollision&&k.allCollisionSquares.length>0){var a=k.allCollisionSquares.pop();w.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#redoBackground",function(){if(!b.editor.drawingCollision&&v.length>0){var a=v.pop();k.allBackgroundSquares.push(a)}else if(b.editor.drawingCollision&&w.length>0){var a=w.pop();k.allCollisionSquares.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#clearBackground",function(){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[]}),$("#scene").on("click","#saveBackground",function(){console.log("Saving!"),c.saveBackground(k.allBackgroundSquares,k.allCollisionSquares,b.editor.currentBackground,k.myCanvas.toDataURL()).done(function(a){console.log(a)})}),$(k.myCanvas).on("mousedown",e),$(k.myCanvas).on("mouseup",f),$(k.myCanvas).on("mouseenter",function(){l=!0,requestAnimationFrame(i)}),$(k.myCanvas).on("mouseleave",function(){l=!1}),$(k.myCanvas).on("mousemove",function(a){m=a.clientX,n=a.clientY}),$(k.myCanvas).on("touchstart",e),$(k.myCanvas).on("touchend",f),$(k.myCanvas).on("touchcancel",f),$(k.myCanvas).on("touchmove",function(a){u="touch",a.preventDefault(),j=a.touches[0],moved=!0})}),angular.module("questCreator").controller("chatCtrl",function(a,b){$("form").submit(function(){return console.log("Submitted!"),a.emit("chat message",$("#m").val()),$("#m").val(""),!1}),a.off("chat message"),a.on("chat message",function(a){$("#messages").append($("<li>").text(a))})}),angular.module("questCreator").controller("detailCtrl",function(a,b,c,d){this.playGame=function(b){a.go("main.game.play")},this.game=b.getGameDetail(),this.sendCollabRequest=function(a){c.validateCollabRequest(a).done(function(b){b.message?(c.sendCollabRequest(a),d.openTemp("alert-request-sent")):b.requested&&!b.accepted?d.openTemp("alert-already-requested"):b.requested||b.accepted?b.requested&&b.accepted?d.open("alert-already-collab"):d.openTemp("fail-request-collab"):(d.open("alert-request-resent"),c.requestAgain(a))})},this.players=[{name:"billy badass",score:72,timeToComplete:"00:45:06"},{name:"jaime presley",score:28,timeToComplete:"incomplete"},{name:"rob helms",score:56,timeToComplete:"02:32:06"},{name:"mr. toups",score:61,timeToComplete:"01:28:15"},{name:"nate",score:36,timeToComplete:"incomplete"},{name:"fitch",score:73,timeToComplete:"03:45:04"}]}),angular.module("questCreator").controller("editorCtrl",function(a,b,c,d,e,f){var g=this;this.dragCalls=0,this.gameInfo={},this.currentEditingGame={name:d.getGameEdit(),description:"",info:this.gameInfo,tags:[],published:!1},this.currentBackground=null,this.currentObject=null,this.currentEntity=null,this.currentScene=null,this.currentEvent=null,this.currentLargeView="map",this.currentSmallView="welcome",this.assetsView="backgrounds",this.qState={undo:"undoBackground",redo:"redoBackground",clear:"clearBackground"},this.availableBackgrounds=[],this.availableObjects=[],this.availableEntities=[],this.availableEvents=[],this.eventTypes=[{name:"text",description:"Events triggered by text input."},{name:"location"},{name:"collision",description:"Events triggered by player position."}],this.eventType=null,this.eventRequirements=["inventory","achievement"],this.selectedAnimation="walkLeft",this.currentColor="green",this.inputColor="green",this.colorPalette={1:"skyblue",2:"green",3:"brown",4:"orange"},this.currentPixelSize=3,this.drawingCollision=!1,this.erasing=!1,this.selectingAssets=!1,this.currentFrameIndex=0,this.modeledFrameIndex=0,this.dragIndex=null,this.dragAsset=null,this.goToPalette=function(b){g.selectingAssets=!0,a.$broadcast("paletteInit",{type:b})},this.selectColor=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(g.inputColor);console.log("color result: ",b);var c=b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null;g.colorPalette[a]="rgb("+c.r+", "+c.g+", "+c.b+")"},null===this.currentEditingGame.name?(e.close(),
e.open("create-game",a)):(e.close(),e.open("edit-game",a)),this.cancel=function(){e.close(),b.go("main.profile")},this.createNewGame=function(b){e.close(),c.createGame(b).done(function(b){g.currentEditingGame=b,c.getGameAssets(b.id).done(function(b){g.availableBackgrounds=b.availableBackgrounds,g.availableObjects=b.availableObstacles,g.availableEntities=b.availableEntities,g.availableEvents=b.availableEvents,g.currentBackground=g.availableBackgrounds[0]||null,a.$apply()})}),d.setGameEdit(b)},this.editGame=function(){e.close(),a.assetsToLoad=0,a.assetsLoaded=0,e.open("loading-screen",a),c.getGame(g.currentEditingGame.name).done(function(b){g.currentEditingGame=b,c.getGameAssets(b.id).done(function(d){g.availableBackgrounds=d.availableBackgrounds,g.availableObjects=d.availableObstacles,g.availableEntities=d.availableEntities,g.availableEvents=d.availableEvents,b.info.maps.forEach(function(b){b.scenes.forEach(function(b){b.forEach(function(b){if(b.background){a.assetsToLoad++;var e=b.background.id;c.getAssetInfo(e,"backgrounds").done(function(c){b.background.info=c,a.assetsLoaded++,a.$apply()}),d.availableBackgrounds.forEach(function(a){e===a.id&&(b.background.thumbnail=a.thumbnail)})}b.entities&&(a.assetsToLoad+=b.entities.length,b.entities.forEach(function(b){var e=b.id;c.getAssetInfo(e,"entities").done(function(c){b.info.animate=c.animate,a.assetsLoaded++,a.$apply()}),d.availableEntities.forEach(function(a){e===a.id&&(b.thumbnail=a.thumbnail)})})),b.objects&&(a.assetsToLoad+=b.objects.length,b.objects.forEach(function(b){var e=b.id;c.getAssetInfo(e,"objects").done(function(c){b.info.collisionMap=c.collisionMap,b.info.image=c.image,a.assetsLoaded++,a.$apply()}),d.availableObstacles.forEach(function(a){e===a.id&&(b.thumbnail=a.thumbnail)})}))})})});var f=setInterval(function(){var b=!1;a.assetsLoaded>=a.assetsToLoad&&(b=!0),b&&(clearInterval(f),a.$apply(),e.close())},200)})}),$(".edit-game").hide()},this.saveGame=function(){e.close(),e.open("loading-screen"),c.saveGame(g.currentEditingGame).done(function(a){e.close()})},this.publishGame=function(){g.currentEditingGame.published=!0,this.saveGame()},this.assetNamer=function(a,b){if(g[b].filter(function(b){return b.name.includes(a.toLowerCase())})){var c=1;g[b].forEach(function(b){c=b.name.includes(a.toLowerCase())?c+1:c}),a=a+" "+c}return a},this.createBackground=function(){var b="New Background",d=g.currentEditingGame.id;b=g.assetNamer(b,"availableBackgrounds"),c.createBackground(b,d).done(function(b){g.availableBackgrounds.push(b),g.currentBackground=b,a.$apply()})},this.editBackground=function(b){c.getAssetInfo(b.id,"backgrounds").done(function(c){b.info=c,g.currentBackground=b,a.$broadcast("redrawBackground",b.info.image,b.info.collisionMap),a.$apply()})},this.createObject=function(){var b="New Object",d=g.currentEditingGame.id;b=g.assetNamer(b,"availableObjects"),c.createObject(b,d).done(function(b){g.availableObjects.push(b),g.currentObject=b,g.currentSmallView="object",a.$apply()})},this.editObject=function(b){c.getAssetInfo(b.id,"obstacles").done(function(c){b.info=c,g.currentObject=b,g.currentSmallView="object",g.qState={undo:"undoObject",redo:"redoObject",clear:"clearObject"},a.$broadcast("redrawObject",b.info.image,b.info.collisionMap),a.$apply()})},this.createEntity=function(){var b="New Entity",d=g.currentEditingGame.id;b=g.assetNamer(b,"availableEntities"),c.createEntity(b,d).done(function(b){e.close(),g.availableEntities.push(b),g.currentEntity=b,g.currentSmallView="entity",a.$apply()})},this.editEntityFrame=function(b){g.currentFrameIndex=g.modeledFrameIndex||0,c.getAssetInfo(b.id,"entities").done(function(c){b.info=c,g.currentEntity=b,g.currentSmallView="entity",g.qState={undo:"undoEntity",redo:"redoEntity",clear:"clearEntity"},a.$broadcast("redrawEntity",b.info.animate[g.selectedAnimation][g.currentFrameIndex].image,b.info.animate[g.selectedAnimation][g.currentFrameIndex].collisionMap),a.$apply()})},this.selectEventType=function(){e.open("event-prompt",a)},this.createEvent=function(b){var d="New Event",f=g.currentEditingGame.id;c.createEvent(d,b,f).done(function(b){e.close(),g.availableEvents.push(b),g.currentEvent=b,g.currentSmallView="event",a.$apply()})},this.editEvent=function(b){g.currentEvent=b,g.currentSmallView="event",a.$apply()},this.setThumbnail=function(a){return void 0!==a&&a.thumbnail?{"background-image":'url("'+a.thumbnail+'")',"background-size":"contain","background-position":"center","background-repeat":"no-repeat"}:{"background-image":"none"}},this.selectText=function(a){a.target.select()},this.positionAsset=function(a){return{top:a.info.pos.y,left:a.info.pos.x,position:"absolute"}},this.dragPositionAsset=function(a,b){g.dragIndex={index:a,type:b}},this.dragAvailableAsset=function(a,b){g.dragAsset={asset:a,type:b}},this.removeAsset=function(a,b){g.currentScene[b].splice(a,1)},this.uiDrag=function(){this.dragCalls++,$(".asset-in-scene").draggable({start:function(a,b){$(b.helper).addClass("grabbed")},stop:function(a,b){$(b.helper).css({transition:"transform ease 100ms"}).removeClass("grabbed")}}),$(".asset.available").draggable({helper:function(){var a=g.dragAsset.asset.thumbnail;return $("<img>").attr("src",a).appendTo("#editor")},start:function(a,b){$(b.helper).addClass("grabbed")},stop:function(a,b){$(b.helper).css({transition:"transform ease 100ms"}).removeClass("grabbed")}}),$("#scene-BG").droppable({drop:function(b,d){if(d.draggable[0].className.toString().includes("-in-scene")){var e=g.dragIndex.type,f=g.dragIndex.index;a.editor.currentScene[e][f].info.pos.x=d.position.left,a.editor.currentScene[e][f].info.pos.y=d.position.top,a.$apply()}else if(d.draggable[0].className.toString().includes("available")){var e=g.dragAsset.type,h=g.dragAsset.asset,i=$("#scene-BG").offset();c.getAssetInfo(h.id,e).done(function(c){h.info=c,h.info.pos.x=b.pageX-i.left,h.info.pos.y=b.pageY-i.top,a.editor.currentScene[e].push(h),a.$apply()})}}})}}),angular.module("questCreator").controller("entCtrl",function(a,b,c){function d(a,b,c,d,e,f){this.x=a,this.y=b,this.width=c,this.height=d,this.color=e,this.type=f}function e(a){o=!0}function f(a){o=!1}function g(){for(var a=0;a<k.allBackgroundSquares.length;a++){var b=k.allBackgroundSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function h(){for(var a=0;a<k.allCollisionSquares.length;a++){var b=k.allCollisionSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function i(){var a=b.editor.currentPixelSize;k.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top};var c=20,e=20,f=x/c,j=y/e,p=b.editor.drawingCollision?"rgba(100, 100, 100, 0.5)":b.editor.currentColor,q=b.editor.drawingCollision?"collision":"normal";k.draw.clearRect(0,0,x,y);for(var r=0;r<=x;r+=f)k.draw.moveTo(r,0),k.draw.lineTo(r,y);for(var r=0;r<=y;r+=j)k.draw.moveTo(0,r),k.draw.lineTo(x,r);k.draw.strokeStyle="rgba(200, 200, 200, 0.5)",k.draw.stroke(),g(),h(),k.draw.fillStyle=p;for(var s=-a;s<=a;s++)for(var t=-a;t<=a;t++){var u=Math.floor((m-k.canvasPos.x)/f+s)*f,v=Math.floor((n-k.canvasPos.y)/j+t)*j;if(b.editor.erasing?(k.draw.strokeStyle="black",k.draw.strokeRect(u,v,f,j)):k.draw.fillRect(u,v,f,j),o)if(b.editor.drawingCollision){if(b.editor.drawingCollision){var w=[];k.allCollisionSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allCollisionSquares.indexOf(a))}),w.forEach(function(a){k.allCollisionSquares.splice(a,1)})}}else{var w=[];k.allBackgroundSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allBackgroundSquares.indexOf(a))}),w.forEach(function(a){k.allBackgroundSquares.splice(a,1)})}if(o&&!b.editor.erasing){var z=new d(u,v,f,j,p,q);b.editor.drawingCollision?k.allCollisionSquares.push(z):k.allBackgroundSquares.push(z)}}l?requestAnimationFrame(i):(k.draw.clearRect(0,0,x,y),g())}var j,k=this,l=!1,m=null,n=null,o=!1,p=850,q=1100,r=1.4,s=2.5,t=1.6,u="",v=[],w=[];this.currentColor=b.editor.currentColor,this.myCanvas=document.getElementById("ent-canvas"),this.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top},this.draw=this.myCanvas.getContext("2d");var x=k.myCanvas.width,y=k.myCanvas.height;this.allCollisionSquares=[],this.allBackgroundSquares=[],d.prototype.draw=function(){k.draw.fillStyle=this.color,window.innerWidth<=p?k.draw.fillRect(this.x*s,this.y*t,this.width,this.height):window.innerWidth<=q?k.draw.fillRect(this.x*r,this.y/r,this.width,this.height):k.draw.fillRect(this.x,this.y,this.width,this.height)},b.$on("redrawEntity",function(a,b,c){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[];k.allBackgroundSquares=b,k.allCollisionSquares=c,g(),h()}),$("#tool-bar").on("click","#undoEntity",function(){if(!b.editor.drawingCollision&&k.allBackgroundSquares.length>0){var a=k.allBackgroundSquares.pop();v.push(a)}else if(b.editor.drawingCollision&&k.allCollisionSquares.length>0){var a=k.allCollisionSquares.pop();w.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#redoEntity",function(){if(!b.editor.drawingCollision&&v.length>0){var a=v.pop();k.allBackgroundSquares.push(a)}else if(b.editor.drawingCollision&&w.length>0){var a=w.pop();k.allCollisionSquares.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#clearEntity",function(){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[]}),$("#saveEntity").click(function(){console.log("saving entity!"),c.saveEntity(k.allBackgroundSquares,k.allCollisionSquares,b.editor.currentEntity,b.editor.selectedAnimation,b.editor.currentFrameIndex,k.myCanvas.toDataURL()).done(function(a){console.log("After save:",a)})}),$("#copyEntity").click(function(){c.copy(k.allBackgroundSquares,k.allCollisionSquares)}),$("#pasteEntity").click(function(){if(b.editor.drawingCollision){if(b.editor.drawingCollision){var a=c.paste("collision");k.allCollisionSquares.push.apply(k.allCollisionSquares,a)}}else{var d=c.paste("image");k.allBackgroundSquares.push.apply(k.allBackgroundSquares,d)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$(k.myCanvas).on("mousedown",e),$(k.myCanvas).on("mouseup",f),$(k.myCanvas).on("mouseenter",function(){l=!0,requestAnimationFrame(i)}),$(k.myCanvas).on("mouseleave",function(){l=!1}),$(k.myCanvas).on("mousemove",function(a){m=a.clientX,n=a.clientY}),$(k.myCanvas).on("touchstart",e),$(k.myCanvas).on("touchend",f),$(k.myCanvas).on("touchcancel",f),$(k.myCanvas).on("touchmove",function(a){u="touch",a.preventDefault(),j=a.touches[0],moved=!0})}),angular.module("questCreator").controller("eventsCtrl",function(a,b,c){this.view="triggers",this.resultType="text",this.requirementType=null,this.requirements={achievements:null,inventory:null},this.locationView="scene",this.map=null,this.scene=null,this.newWord=null,this.wordBuffer={},this.counter=0,this.log=function(){console.log(b.editor.currentEvent),console.log("requirements: ",this.requirements)},this.save=function(a){c.saveEvent(a).done(function(a){})},this.findRequirements=function(){var a=[],c=[];b.editor.currentEditingGame.info.maps.forEach(function(b){b.scenes.forEach(function(b){b.forEach(function(b){b.events&&b.events.forEach(function(b){b.info.results.achievements.forEach(function(b){a.push(b.name)}),b.info.results.inventory.forEach(function(a){c.push(a)})})})})}),this.requirements={achievements:a,inventory:c}},this.addRequirement=function(a,c){0===b.editor.currentEvent.info.requirements.length&&(b.editor.currentEvent.info.requirements={achievements:[],inventory:[]}),b.editor.currentEvent.info.requirements[c].push(a)},this.anyRequirements=function(){if(!b.editor.currentEvent)return!1;b.editor.currentEvent.info.requirements.achievements||(b.editor.currentEvent.info.requirements.achievements=[]),b.editor.currentEvent.info.requirements.inventory||(b.editor.currentEvent.info.requirements.inventory=[]);var a=b.editor.currentEvent.info.requirements;return a.achievements.length>0||a.inventory.length>0},this.addWordList=function(a){if(!a)return void console.log("no word!");var c=[a];b.editor.currentEvent.info.triggers.push(c),this.newWord=null,this.counter++},this.addAlias=function(a,c){return a?(b.editor.currentEvent.info.triggers[c].push(a),void this.counter++):void console.log("no word!")},this.bufferIndex=function(){return this.counter},this.selectScene=function(a){this.scene=a,a.background?(b.editor.currentEvent.info.thumbnail=a.background.thumbnail,console.log("added thumbnail")):b.editor.currentEvent.info.thumbnail=!1},this.anyResults=function(){if(!b.editor.currentEvent)return!1;b.editor.currentEvent.info.results||(b.editor.currentEvent.info.results={text:[],achievements:[],inventory:[],portal:{}}),b.editor.currentEvent.info.results.achievements||(b.editor.currentEvent.info.results.achievements=[]),b.editor.currentEvent.info.results.inventory||(b.editor.currentEvent.info.results.inventory=[]),b.editor.currentEvent.info.results.text||(b.editor.currentEvent.info.results.text=[]),b.editor.currentEvent.info.results.portal||(b.editor.currentEvent.info.results.portal={});var a=b.editor.currentEvent.info.results;return a.text.length>0||a.achievements.length>0||a.inventory.length>0||Object.keys(a.portal).length>0},this.addText=function(){b.editor.currentEvent.info.results.text.push("")},this.removeText=function(a){b.editor.currentEvent.info.results.text.splice(a,1)},this.addAchievement=function(){b.editor.currentEvent.info.results.achievements.push({name:"",description:"",points:0})},this.removeAchievement=function(a){b.editor.currentEvent.info.results.achievements.splice(a,1)},this.addItem=function(){b.editor.currentEvent.info.results.inventory.push("")},this.removeItem=function(a){b.editor.currentEvent.info.results.inventory.splice(a,1)}}),angular.module("questCreator").controller("gameCtrl",function(a,b,c){}),angular.module("questCreator").controller("landingCtrl",function(a,b,c,d,e,f){this.searching=!1;var g=this;d.getGames().done(function(a){g.allGames=a,b.$apply()}),b.createGame=function(){var d=c.get();d.id?(d.editGame=null,c.set(d),a.go("main.game.editor.views")):(e.openTemp("signin-to-continue"),b.signIn())},b.goToGameDetail=function(c){b.main.loggedIn||(e.openTemp("signin-to-continue"),b.main.signIn()),f.setPlayingGame(c.name),d.setGameDetail(c),a.go("main.game.detail")},this.searchGames=function(a){this.searching=!0,d.searchGames(a).done(function(a){g.allGames=a,b.$apply()})},this.showAll=function(){this.searching=!1,d.getGames().done(function(a){g.allGames=a,b.$apply()})}}),angular.module("questCreator").controller("mainCtrl",function(a,b,c,d,e){this.loggedIn=null,e.popupTemp=!1,this.goHome=function(){b.go("main.landing")},this.goToUser=function(){c.get().id?b.go("main.profile"):(d.openTemp("signin-to-continue"),e.signIn())},this.signIn=function(){c.signIn()},this.signOut=function(){c.signOut();var a={uid:null,token:null,username:null,picture:null,id:null,games:null,joined:null,editGame:null};c.set(a),b.go("main.landing")},this.register=function(a){c.register(a)},this.cancelRegister=function(){d.close(),b.go("main.landing"),c.signOut()},this.cancel=function(){d.close(),b.go("main.landing")},this.okay=function(){d.close()}}),angular.module("questCreator").controller("mapCtrl",function(a,b){var c=this;this.width=1,this.height=1,this.createMap=function(){var a="New Map",c="New Scene (1, 1)",d={name:c,background:void 0,objects:[],entities:[],events:[]},e={name:a,scenes:[[d]]};b.editor.currentEditingGame.info.maps.push(e)},this.sceneNamer=function(a){if([address].filter(function(a){return a.name.includes(name.toLowerCase())})){var b=1;[address].forEach(function(a){b=a.name.includes(name.toLowerCase())?b+1:b}),name=name+" "+b}return name},this.initScene=null,this.createMapRow=function(a){var d="New Scene ("+c.initScene[0]+", "+c.initScene[1]+")",e={name:d,background:void 0,objects:[],entities:[],events:[]};b.editor.currentEditingGame.info.maps[b.editor.currentEditingGame.info.maps.indexOf(a)].scenes.push([e])},this.createScene=function(a,d){var e="New Scene ("+c.initScene[0]+", "+c.initScene[1]+")",f={name:e,background:void 0,objects:[],entities:[],events:[]};b.editor.currentEditingGame.info.maps[b.editor.currentEditingGame.info.maps.indexOf(a)].scenes[d].push(f)},this.editScene=function(a){a.events||(a.events=[]),b.editor.currentScene=a,b.editor.currentLargeView="scene"}}),angular.module("questCreator").controller("objCtrl",function(a,b,c){function d(a,b,c,d,e,f){this.x=a,this.y=b,this.width=c,this.height=d,this.color=e,this.type=f}function e(a){o=!0}function f(a){o=!1}function g(){for(var a=0;a<k.allBackgroundSquares.length;a++){var b=k.allBackgroundSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function h(){for(var a=0;a<k.allCollisionSquares.length;a++){var b=k.allCollisionSquares[a];k.draw.fillStyle=b.color,k.draw.fillRect(b.x,b.y,b.width,b.height)}}function i(){var a=b.editor.currentPixelSize;k.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top};var c=20,e=20,f=x/c,j=y/e,p=b.editor.drawingCollision?"rgba(100, 100, 100, 0.5)":b.editor.currentColor,q=b.editor.drawingCollision?"collision":"normal";k.draw.clearRect(0,0,x,y);for(var r=0;r<=x;r+=f)k.draw.moveTo(r,0),k.draw.lineTo(r,y);for(var r=0;r<=y;r+=j)k.draw.moveTo(0,r),k.draw.lineTo(x,r);k.draw.strokeStyle="rgba(200, 200, 200, 0.5)",k.draw.stroke(),g(),h(),k.draw.fillStyle=p;for(var s=-a;s<=a;s++)for(var t=-a;t<=a;t++){var u=Math.floor((m-k.canvasPos.x)/f+s)*f,v=Math.floor((n-k.canvasPos.y)/j+t)*j;if(b.editor.erasing?(k.draw.strokeStyle="black",k.draw.strokeRect(u,v,f,j)):k.draw.fillRect(u,v,f,j),o)if(b.editor.drawingCollision){if(b.editor.drawingCollision){var w=[];k.allCollisionSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allCollisionSquares.indexOf(a))}),w.forEach(function(a){k.allCollisionSquares.splice(a,1)})}}else{var w=[];k.allBackgroundSquares.forEach(function(a){u===a.x&&v===a.y&&w.push(k.allBackgroundSquares.indexOf(a))}),w.forEach(function(a){k.allBackgroundSquares.splice(a,1)})}if(o&&!b.editor.erasing){var z=new d(u,v,f,j,p,q);b.editor.drawingCollision?k.allCollisionSquares.push(z):k.allBackgroundSquares.push(z)}}l?requestAnimationFrame(i):(k.draw.clearRect(0,0,x,y),g())}var j,k=this,l=!1,m=null,n=null,o=!1,p=850,q=1100,r=1.4,s=2.5,t=1.6,u="",v=[],w=[];this.currentColor=b.editor.currentColor,this.myCanvas=document.getElementById("obj-canvas"),this.canvasPos={x:k.myCanvas.getBoundingClientRect().left,y:k.myCanvas.getBoundingClientRect().top},this.draw=this.myCanvas.getContext("2d");var x=k.myCanvas.width,y=k.myCanvas.height;this.allCollisionSquares=[],this.allBackgroundSquares=[],d.prototype.draw=function(){k.draw.fillStyle=this.color,window.innerWidth<=p?k.draw.fillRect(this.x*s,this.y*t,this.width,this.height):window.innerWidth<=q?k.draw.fillRect(this.x*r,this.y/r,this.width,this.height):k.draw.fillRect(this.x,this.y,this.width,this.height)},b.$on("redrawObject",function(a,b,c){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[];k.allBackgroundSquares=b,k.allCollisionSquares=c,g(),h()}),$("#tool-bar").on("click","#undoObject",function(){if(!b.editor.drawingCollision&&k.allBackgroundSquares.length>0){var a=k.allBackgroundSquares.pop();v.push(a)}else if(b.editor.drawingCollision&&k.allCollisionSquares.length>0){var a=k.allCollisionSquares.pop();w.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#redoObject",function(){if(!b.editor.drawingCollision&&v.length>0){var a=v.pop();k.allBackgroundSquares.push(a)}else if(b.editor.drawingCollision&&w.length>0){var a=w.pop();k.allCollisionSquares.push(a)}k.draw.clearRect(0,0,k.myCanvas.width,k.myCanvas.height),g(),h()}),$("#tool-bar").on("click","#clearObject",function(){x=k.myCanvas.width,y=k.myCanvas.height,k.draw.clearRect(0,0,x,y),k.allBackgroundSquares=[],k.allCollisionSquares=[]}),$(".asset-container").on("click","#saveObject",function(){console.log("Saving Object!"),c.saveObject(k.allBackgroundSquares,k.allCollisionSquares,b.editor.currentObject,k.myCanvas.toDataURL()).done(function(a){console.log(a)})}),$(k.myCanvas).on("mousedown",e),$(k.myCanvas).on("mouseup",f),$(k.myCanvas).on("mouseenter",function(){l=!0,requestAnimationFrame(i)}),$(k.myCanvas).on("mouseleave",function(){l=!1}),$(k.myCanvas).on("mousemove",function(a){m=a.clientX,n=a.clientY}),$(k.myCanvas).on("touchstart",e),$(k.myCanvas).on("touchend",f),$(k.myCanvas).on("touchcancel",f),$(k.myCanvas).on("touchmove",function(a){u="touch",a.preventDefault(),j=a.touches[0],moved=!0})}),angular.module("questCreator").controller("paletteCtrl",function(a,b,c){var d=this;this.elements=[],this.currentType="",b.$on("paletteInit",function(e,f){a.getByType(f.type).then(function(c){d.assets=c,b.$apply(),d.currentType=a.getCurrentType(),b.$apply()}),d.searchByTag=function(c){a.getByTag(c).done(function(a){d.assets=a,b.$apply()})},d.goToEditor=function(){if(d.elements.length>0){var a=confirm("Do you wanna save the assets you chose before leaving this screen?");a&&d.saveElements()}this.elements=[],b.editor.selectingAssets=!1},d.testDupes=function(a,c){var e=!0;c===b.editor.currentEditingGame.id&&(e=!1);for(var f=0;f<d.elements.length;f++)d.elements[f].id===a&&(e=!1);return e},d.addToPalette=function(a,e){d.assets.forEach(function(a){}),d.assets.splice(e,1);var f=angular.copy(a);c.getAssetInfo(f.id,d.currentType).done(function(a){f.info=a,d.elements.push(f),b.$apply()})},d.removeFromPalette=function(a){d.elements.splice(a,1)},d.saveElements=function(){var a=null;if("backgrounds"===d.currentType)for(var e=0;e<d.elements.length;e++)a=d.elements[e],c.createBackground(a.name,b.editor.currentEditingGame.id,a.info,a.thumbnail).done(function(a){b.editor.availableBackgrounds.push(a)});else if("obstacles"===d.currentType)for(var f=0;f<d.elements.length;f++)a=d.elements[f],c.createObject(a.name,b.editor.currentEditingGame.id,a.info).done(function(a){b.editor.availableObjects.push(a)});else if("entities"===d.currentType)for(var g=0;g<d.elements.length;g++)a=d.elements[g],c.createEntity(a.name,b.editor.currentEditingGame.id,a.info).done(function(a){b.editor.availableEntities.push(a)});return d.elements=[],d.elements}})}),angular.module("questCreator").controller("playCtrl",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this;f.checkLogin().then(function(c){function d(a){a=a.toLowerCase();var b=!1;T?T.forEach(function(c){if("text"===c.category){var d=c.info;if(!b){var e=!0;if(d.requirements.achievements&&d.requirements.achievements.forEach(function(a){m.saveInfo.achievements.indexOf(a)===-1&&(e=!1)}),d.requirements.inventory&&d.requirements.inventory.forEach(function(a){m.saveInfo.inventory.indexOf(a)===-1&&(e=!1)}),e){var f=!0;if(d.triggers.forEach(function(b){var c=!1;b.forEach(function(b){b=b.toLowerCase(),a.includes(b)&&(c=!0)}),c||(f=!1,m.responding.phrase="I have literally no idea what you just said.",m.responding.show=!0,m.pause=!0)}),f&&(b=!0,d.results.text.forEach(function(a){m.responding.phrase=a,m.responding.show=!0,m.pause=!0}),d.results.inventory.forEach(function(a){m.saveInfo.inventory.push(a)}),d.results.achievements.forEach(function(a){m.saveInfo.achievements.push(a.name),m.saveInfo.score+=a.points}),d.results.portal.scenePos)){var g=d.results.portal;m.currentScenePos=angular.copy(g.scenePos),q(),P.info.pos=angular.copy(g.pos)}}}}}):(m.responding.phrase="I have literally no idea what you just said.",m.responding.show=!0,m.pause=!0)}function i(a){var b=!1;T&&T.forEach(function(c){if("location"===c.category&&(locationEvent=c.info,!b)){var d=!0;if(locationEvent.requirements.forEach(function(a){"achievement"===a.type&&m.saveInfo.achievements.indexOf(a.value)===-1?d=!1:"inventory"===a.type&&m.saveInfo.inventory.indexOf(a.value)===-1&&(d=!1)}),d){var e=!1;if(locationEvent.triggers.forEach(function(b){a.left<=b.right&&a.right>=b.left&&a.top<=b.bottom&&a.bottom>=b.top&&(e=!0)}),e&&(b=!0,locationEvent.results.text.forEach(function(a){m.responding.phrase=a,m.responding.show=!0,m.pause=!0}),locationEvent.results.inventory.forEach(function(a){m.saveInfo.inventory.push(a)}),locationEvent.results.achievements.forEach(function(a){m.saveInfo.achievements.push(a.name),m.saveInfo.score+=a.points}),locationEvent.results.portal.scenePos)){var f=locationEvent.results.portal;m.currentScenePos=angular.copy(f.scenePos),q(),P.info.pos=angular.copy(f.pos)}}}})}function n(){if(P.info.currentFrame.collisionMap[0]){var a=P.info.currentFrame.collisionMap[0].x,b=P.info.currentFrame.collisionMap[0].x+P.info.currentFrame.collisionMap[0].width,c=P.info.currentFrame.collisionMap[0].y,d=P.info.currentFrame.collisionMap[0].y+P.info.currentFrame.collisionMap[0].height;P.info.currentFrame.collisionMap.forEach(function(e){e.x<a&&(a=e.x),e.x+e.width>b&&(b=e.x+e.width),e.y<c&&(c=e.y),e.y+e.height>d&&(d=e.y+e.height)}),P.bounds={left:a+P.info.pos.x,right:b+P.info.pos.x,top:c+P.info.pos.y,bottom:d+P.info.pos.y,width:b-a,height:d-c},i(P.bounds),P.bounds.right<0?(m.currentScenePos[2]--,m.currentScenePos[2]<0&&(m.currentScenePos[2]=m.currentRow.length-1),q(),P.info.pos.x+=M):P.bounds.left>M?(m.currentScenePos[2]++,m.currentScenePos[2]>m.currentRow.length-1&&(m.currentScenePos[2]=0),q(),P.info.pos.x-=M):P.bounds.bottom<0?(m.currentScenePos[1]--,m.currentScenePos[1]<0&&(m.currentScenePos[1]=m.allRows.length-1),q(),P.info.pos.y+=N):P.bounds.top>N&&(m.currentScenePos[1]++,m.currentScenePos[1]>m.allRows.length-1&&(m.currentScenePos[1]=0),q(),P.info.pos.y-=N)}}function o(){var b={found:!1,direction:"none",type:"none"};if(P.info.currentFrame.collisionMap.forEach(function(a){var c=a.x+P.info.pos.x,d=a.x+a.width+P.info.pos.x,e=a.y+P.info.pos.y,f=a.y+a.height+P.info.pos.y;Q&&Q.info.collisionMap.forEach(function(a){var g=a.x,h=a.x+a.width,i=a.y,j=a.y+a.height;c<=h&&d>=g&&e<=j&&f>=i&&(b.found=!0,b.type="wall",P.info.speed.x>0?b.direction="right":P.info.speed.x<0?b.direction="left":P.info.speed.y<0?b.direction="up":P.info.speed.y>0&&(b.direction="down"))}),R&&R.forEach(function(a){if(a.info.collisionMap[0]){var g=a.info.collisionMap[0].x,h=a.info.collisionMap[0].x+a.info.collisionMap[0].width,i=a.info.collisionMap[0].y,j=a.info.collisionMap[0].y+a.info.collisionMap[0].height;a.info.collisionMap.forEach(function(a){a.x<g&&(g=a.x),a.x+a.width>h&&(h=a.x+a.width),a.y<i&&(i=a.y),a.y+a.height>j&&(j=a.y+a.height)}),a.bounds={left:g+a.info.pos.x,right:h+a.info.pos.x,top:i+a.info.pos.y,bottom:j+a.info.pos.y,width:h-g,height:j-i}}a.info.collisionMap.forEach(function(g){var h=g.x+a.info.pos.x,i=g.x+g.width+a.info.pos.x,j=g.y+a.info.pos.y,k=g.y+g.height+a.info.pos.y;c<=i&&d>=h&&e<=k&&f>=j&&(b.found=!0,b.type="wall",P.info.speed.x>0?b.direction="right":P.info.speed.x<0?b.direction="left":P.info.speed.y<0?b.direction="up":P.info.speed.y>0&&(b.direction="down"))})}),S&&S.forEach(function(a){if(a.info.currentFrame.collisionMap[0]){var g=a.info.currentFrame.collisionMap[0].x,h=a.info.currentFrame.collisionMap[0].x+a.info.currentFrame.collisionMap[0].width,i=a.info.currentFrame.collisionMap[0].y,j=a.info.currentFrame.collisionMap[0].y+a.info.currentFrame.collisionMap[0].height;a.info.currentFrame.collisionMap.forEach(function(a){a.x<g&&(g=a.x),a.x+a.width>h&&(h=a.x+a.width),a.y<i&&(i=a.y),a.y+a.height>j&&(j=a.y+a.height)}),a.bounds={left:g+a.info.pos.x,right:h+a.info.pos.x,top:i+a.info.pos.y,bottom:j+a.info.pos.y,width:h-g,height:j-i}}a.info.currentFrame.collisionMap.forEach(function(g){var h=(g.x+a.info.pos.x)*a.scale,i=(g.x+g.width+a.info.pos.x)*a.scale,j=(g.y+a.info.pos.y)*a.scale,k=(g.y+g.height+a.info.pos.y)*a.scale;c<=i&&d>=h&&e<=k&&f>=j&&(b.found=!0,b.type="wall",P.info.speed.x>0?b.direction="right":P.info.speed.x<0?b.direction="left":P.info.speed.y<0?b.direction="up":P.info.speed.y>0&&(b.direction="down"))})})}),b.found){switch(b.type){case"wall":P.collide(b.direction),H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},a.emit("update player",H)}b={found:!1,direction:"none",type:"none"}}}function p(){S&&S.forEach(function(a){var b={found:!1,direction:"none",type:"none"};if(a.info.currentFrame.collisionMap.forEach(function(c){var d=(c.x+a.info.pos.x)*a.scale,e=(c.x+c.width+a.info.pos.x)*a.scale,f=(c.y+a.info.pos.y)*a.scale,g=(c.y+c.height+a.info.pos.y)*a.scale;Q&&Q.info.collisionMap.forEach(function(c){var h=c.x,i=c.x+c.width,j=c.y,k=c.y+c.height;d<=i&&e>=h&&f<=k&&g>=j&&(b.found=!0,b.type="wall",a.info.speed.x>0?b.direction="right":a.info.speed.x<0?b.direction="left":a.info.speed.y<0?b.direction="up":a.info.speed.y>0&&(b.direction="down"))}),R&&R.forEach(function(c){if(c.info.collisionMap[0]){var h=c.info.collisionMap[0].x,i=c.info.collisionMap[0].x+c.info.collisionMap[0].width,j=c.info.collisionMap[0].y,k=c.info.collisionMap[0].y+c.info.collisionMap[0].height;c.info.collisionMap.forEach(function(a){a.x<h&&(h=a.x),a.x+a.width>i&&(i=a.x+a.width),a.y<j&&(j=a.y),a.y+a.height>k&&(k=a.y+a.height)}),c.bounds={left:h+c.info.pos.x,right:i+c.info.pos.x,top:j+c.info.pos.y,bottom:k+c.info.pos.y,width:i-h,height:k-j}}c.info.collisionMap.forEach(function(h){var i=h.x+c.info.pos.x,j=h.x+h.width+c.info.pos.x,k=h.y+c.info.pos.y,l=h.y+h.height+c.info.pos.y;d<=j&&e>=i&&f<=l&&g>=k&&(b.found=!0,b.type="wall",a.info.speed.x>0?b.direction="right":a.info.speed.x<0?b.direction="left":a.info.speed.y<0?b.direction="up":a.info.speed.y>0&&(b.direction="down"))})})}),b.found){switch(b.type){case"wall":a.collide(b.direction)}b={found:!1,direction:"none",type:"none"}}})}function q(){m.saveInfo.scenePos=m.currentScenePos,G.scenePos=m.currentScenePos,m.currentMap=Y[m.currentScenePos[0]],m.allRows=m.currentMap.scenes,m.currentRow=m.allRows[m.currentScenePos[1]],m.currentScene=m.currentRow[m.currentScenePos[2]],H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},Q=m.currentScene.background,T=m.currentScene.events,R=m.currentScene.objects,r()}function r(){S=[];var a=angular.copy(m.currentScene.entities);a.forEach(function(a){var b=new e(a);S.push(b)}),V=!0}function s(){P.updatePos(),G.avatar=P,H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},F>E&&(a.emit("update player",H),F=0),F++}function t(){S.forEach(function(a){a.updatePos()})}function u(a){a.checkAction(),L.save(),L.translate(a.info.pos.x,a.info.pos.y),L.scale(a.scale,a.scale),a.info.currentFrame.image.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.globalAlpha=.2,a.info.currentFrame.collisionMap.length>0&&a.info.currentFrame.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.restore()}function v(){I.forEach(function(a){a.scenePos[0]===G.scenePos[0]&&a.scenePos[1]===G.scenePos[1]&&a.scenePos[2]===G.scenePos[2]&&u(a.avatar)})}function w(){if(Q){L.save(),L.globalCompositeOperation="destination-over";for(var a=Q.info.image.length-1;a>=0;a--){var b=Q.info.image[a];L.fillStyle=b.color,L.fillRect(b.x,b.y,b.width,b.height)}L.globalCompositeOperation="source-over",L.globalAlpha=.2,Q.info.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.restore()}else m.warning="This scene has no background yet!",setTimeout(function(){m.warning=""},2e3);j.$apply()}function x(a){R&&R.forEach(function(b){L.save(),L.translate(b.info.pos.x,b.info.pos.y),b.bounds?(P.bounds.top>b.bounds.bottom&&"background"===a||P.bounds.top<b.bounds.bottom&&"foreground"===a)&&(b.info.image.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.globalAlpha=.2,b.info.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height);
})):"background"===a&&(b.info.image.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.globalAlpha=.2,b.info.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)})),L.restore()})}function y(a){S&&S.forEach(function(b){b.checkAction(),L.save(),L.translate(b.info.pos.x,b.info.pos.y),L.scale(b.scale,b.scale),b.bounds?(P.bounds.top>b.bounds.bottom&&"background"===a||P.bounds.top<b.bounds.bottom&&"foreground"===a)&&(b.info.currentFrame.image.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.globalAlpha=.2,b.info.currentFrame.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)})):"background"===a&&(b.info.currentFrame.image.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)}),L.globalAlpha=.2,b.info.currentFrame.collisionMap.forEach(function(a){L.fillStyle=a.color,L.fillRect(a.x,a.y,a.width,a.height)})),L.restore()})}function z(){L.clearRect(0,0,M,N)}function A(){var a=new Date;m.timeDiff=Math.floor((a-m.startTime)/1e3);var b=m.timeDiff%60,c=Math.floor(m.timeDiff/60)%60,d=Math.floor(m.timeDiff/3600);b=b<10?"0"+b:b,c=c<10?"0"+c:c,d=d<10?"0"+d:d,m.displayTime=d+":"+c+":"+b}function B(){f.getPlayerAvatar().done(function(c){P=new b(c),P.info.pos.x=X.x,P.info.pos.y=X.y,P.info.currentFrame=P.info.animate.walkLeft[0],U=!0,G.avatar=P,q(),D(),a.emit("game joined",G)})}function C(){m.gameStarted&&(z(),U&&(A(),s(),n(),o(),t(),p(),y("background"),x("background"),u(P),v(),y("foreground"),x("foreground"),w())),m.pause||requestAnimationFrame(C)}function D(){a.off("self info"),a.on("self info",function(a){G.socketId=a}),a.off("new player"),a.on("new player",function(a){var b="Player "+a.id+" is playing "+a.game;$(".chat-messages").append($("<li>").text(b))}),a.off("draw new player"),a.on("draw new player",function(c){c.avatar=new b(c.avatar),I.push(c);var d={data:G,dest:c.socketId};a.emit("draw old player",d)}),a.off("draw old player"),a.on("draw old player",function(a){a.avatar=new b(a.avatar),I.push(a)}),a.off("update player"),a.on("update player",function(a){for(var b=0;b<I.length;b++)I[b].id===a.id&&(I[b].avatar.action=angular.copy(a.action),I[b].scenePos=angular.copy(a.scenePos),I[b].avatar.info.pos=angular.copy(a.pos))}),$(".chat-submit").submit(function(){var b={msg:J.id+": "+$(".message").val(),gameName:m.gameName};return a.emit("chat message",b),$(".message").val(""),!1}),a.off("chat message"),a.on("chat message",function(a){$(".chat-messages").append($("<li>").text(a))}),a.off("player left"),a.on("player left",function(a){var b="Player "+a.id+" left "+a.game;$(".chat-messages").append($("<li>").text(b));for(var c=null,d=0;d<I.length;d++)I[d].id===a.id&&(c=d);null!==c&&I.splice(c,1)}),j.$on("$destroy",function(){var b={id:J.id,game:m.gameName};a.emit("game left",b)})}var E=50,F=0,G={id:null,game:null,scenePos:null,avatar:null,socketId:null},H={id:null,game:null,scenePos:null,socketId:null},I=[],J={id:f.get().id},K=document.getElementById("play-canvas"),L=K.getContext("2d"),M=700,N=500;m.warning="",m.typing={show:!1,phrase:""},m.responding={show:!1,phrase:""},m.showingInventory=!1;var O=!1,P=null,Q=null,R=null,S=null,T=null,U=!1,V=!1;m.gameName=l.getPlayingGame()||h.getGameDetail().name||"harry potter quest";var W=null,X=null,Y=null,Z=null;m.currentMap=null,m.allRows=null,m.currentRow=null,m.currentScene=null,m.currentScenePos=[0,0,0],m.gameLoaded=!1,m.allSavedGames=l.getSavedGames(m.gameName)||[],m.saveInfo={game:"",name:"",score:0,time:0,inventory:[],achievements:[],scenePos:[1,0,0],pos:{x:350,y:250}},m.startTime=new Date,m.timeDiff=0,m.displayTime="",m.gameStarted=!1,m.saveGame=function(){m.saveInfo.time=m.timeDiff,m.saveInfo.pos=P.info.pos;var a=angular.copy(m.saveInfo);m.allSavedGames.push(a),l.setSavedGames(m.gameName,m.allSavedGames),m.saveInfo.name=""},m.restoreGame=function(a){m.saveInfo=angular.copy(a),m.startTime=Date.now()-1e3*angular.copy(a.time),m.currentScenePos=angular.copy(a.scenePos),q(),P.info.pos=angular.copy(a.pos)},$("body").off("keyup").on("keyup",function(b){var c=b.which;8===c&&(m.typing.phrase.length>1?m.typing.phrase=m.typing.phrase.substring(0,m.typing.phrase.length-1):(m.typing.phrase="",m.typing.show=!1)),27===c&&(0===$(".option.active").length?($(".fileOption").addClass("active"),$(".save").addClass("active"),m.pause=!0):($(".option.active").removeClass("active"),$(".save").removeClass("active"),m.pause=!1,C())),37===c?(m.pause&&0===$(".fileOption.active").length&&$(".option.active").toggleClass("active").prev(".option").toggleClass("active"),m.pause||(P.action="walkLeft"===P.action?"stand":"walkLeft",H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},a.emit("update player",H))):38===c?(m.pause&&1===$(".fileOption.active").length&&0===$(".save.active").length&&$(".fileOptions li.active").toggleClass("active").prev("li").toggleClass("active"),m.pause||(P.action="walkUp"===P.action?"stand":"walkUp",H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},a.emit("update player",H))):39===c?(m.pause&&0===$(".timeOption.active").length&&$(".option.active").toggleClass("active").next(".option").toggleClass("active"),m.pause||(P.action="walkRight"===P.action?"stand":"walkRight",H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},a.emit("update player",H))):40===c?(m.pause&&1===$(".fileOption.active").length&&0===$(".restore.active").length&&$(".fileOptions li.active").toggleClass("active").next("li").toggleClass("active"),m.pause||(P.action="walkDown"===P.action?"stand":"walkDown",H={id:angular.copy(G.id),game:angular.copy(G.game),scenePos:angular.copy(G.scenePos),socketId:angular.copy(G.socketId),action:angular.copy(P.action),pos:angular.copy(P.info.pos)},a.emit("update player",H))):191===c&&(m.pause||m.typing.show||m.responding.show||0!==$(".active").length||$(".message").is(":focus")||(m.pause=!0,m.showingInventory=!0))}),$("body").off("keypress").on("keypress",function(a){var b=a.which;if(m.typing.show&&b>=32&&b<=220&&!m.responding.show&&0===$(".active").length){O=!0;var c=String.fromCharCode(b);m.typing.phrase+=c}else if(13===b){if(m.typing.show){m.typing.show=!1;var e=m.typing.phrase;m.typing.phrase="",d(e)}else m.responding.show?(m.responding.show=!1,m.responding.phrase=""):m.showingInventory?m.showingInventory=!1:1===$(".invOption.active").length?(m.showingInventory=!0,$(".option.active").removeClass("active"),C()):1===$(".save.active").length?(m.savingGame=!0,$(".fileOption").removeClass("active"),$(".save.active").removeClass("active"),C()):1===$(".restore.active").length&&(m.restoringGame=!0,$(".fileOption").removeClass("active"),$(".restore.active").removeClass("active"),C());m.responding.show||m.showingInventory||0!==$(".active").length||(m.pause=!1,C())}else 32!==b||$(".message").is(":focus")||m.savingGame||m.restoringGame||m.showingInventory||m.typing.show||(m.typing.phrase=":",m.typing.show=!0)}),j.assetsToLoad=0,j.assetsLoaded=0,k.open("loading-screen",j),Z=h.loadGame(m.gameName).done(function(a){a.info.maps.forEach(function(a){a.scenes.forEach(function(a){a.forEach(function(a){if(a.background){j.assetsToLoad++;var b=a.background.id;g.getAssetInfo(b,"backgrounds").done(function(b){a.background.info=b,j.assetsLoaded++,j.$apply()})}a.entities&&(j.assetsToLoad+=a.entities.length,a.entities.forEach(function(a){var b=a.id;g.getAssetInfo(b,"entities").done(function(b){a.info.animate=b.animate,j.assetsLoaded++,j.$apply()})})),a.objects&&(j.assetsToLoad+=a.objects.length,a.objects.forEach(function(a){var b=a.id;g.getAssetInfo(b,"objects").done(function(b){a.info.collisionMap=b.collisionMap,a.info.image=b.image,j.assetsLoaded++,j.$apply()})}))})})});var b=setInterval(function(){var c=!1;j.assetsLoaded>=j.assetsToLoad&&(c=!0),c&&(clearInterval(b),k.close(),m.gameLoaded=!0,W=a.info,Y=W.maps,m.currentMap=Y[0],m.allRows=m.currentMap.scenes,m.currentRow=m.allRows[0],m.currentScene=m.currentRow[0],Q=m.currentScene.background,R=m.currentScene.objects,r(),T=m.currentScene.events,y("background"),x("background"),w(),X={map:1,row:0,column:0,x:300,y:250},j.$apply())},200)}),m.startGame=function(){G.id=J.id,G.game=m.gameName,m.currentScenePos=[X.map,X.row,X.column],G.scenePos=m.currentScenePos,B(),m.startTime=new Date,m.gameStarted=!0},requestAnimationFrame(C),j.$apply()})}),angular.module("questCreator").controller("profileCtrl",function(a,b,c,d,e){c.showReqs=!1,c.showCollabs=!1,c.requestActive=!1,c.collabActive=!1,c.games=null,c.requests=null,c.avatars=null,c.large=null,d.checkLogin().then(function(a){e.open("loading-screen"),c.user=d.get(),c.getJoinedDate=function(a){return new Date(a)},d.getUserGames().done(function(a){c.games=a,c.$apply(),d.getCollabRequests().done(function(a){c.requests=a,c.$apply()}),d.getCollaborators().done(function(a){c.collaborators=a,c.$apply()}),d.getAvatars().done(function(a){c.avatars=a;for(var b=0;b<a.length;b++)a[b].current&&(c.large=a[b]),c.$apply();e.close()})}),d.getCollaborations().done(function(a){c.collaborations=a,c.$apply()}),c.createGame=function(){c.user.editGame=null,d.set(c.user),b.go("main.game.editor.views")},c.editGame=function(a){c.user.editGame=a,d.set(c.user),b.go("main.game.editor.views")},c.archiveGame=function(a,b){var e=confirm("Are you sure you wanna archive '"+a.name+"'? That means no one will be able to play it and all player information will be lost. You will NOT be able to retrieve this later");e&&(console.log("before",c.games),d.archive(a.id).done(function(a){c.games.splice(b,1),c.$apply()}))},c.showCollaborators=function(){c.collabActive=!c.collabActive,c.showCollabs=!c.showCollabs},c.showRequests=function(){c.requestActive=!c.requestActive,c.showReqs=!c.showReqs},c.toggleCollab=function(a){d.toggleAccepted(a.game_id,a.user_id);var b=c.games;d.getCollabRequests().done(function(a){getGameName(a,b)}),d.getCollaborators().done(function(a){filterCollaborators(a,b)})},c.removeRequest=function(a,b){d.toggleRequested(a.game_id,a.user_id).done(function(a){c.requests.splice(b,1),c.$apply()})},c.removeCollaborator=function(a,b){a.requested&&d.toggleRequested(a.game_id,a.user_id),d.toggleAccepted(a.game_id,a.user_id).done(function(a){c.collaborators.splice(b,1),c.$apply()})},c.highlightAvatar=function(a,b){c.large=a},c.updateDefault=function(){if(c.large){for(var a=0;a<c.avatars.length;a++)c.avatars[a].current&&c.avatars[a].id!==c.large.id&&(c.avatars[a].current=!1,d.updateAvatar(!1,c.avatars[a].id)),c.avatars[a].id===c.large.id&&(c.avatars[a].current=c.large.current);d.updateAvatar(c.large.current,c.large.id)}},c.openToEdit=function(){e.open("edit-username",c)},c.cancel=function(){e.close()},c.editUsername=function(a){console.log("here"),e.close(),c.user.username=a,d.editUsername(a)}})}),angular.module("questCreator").controller("sceneCtrl",function(a,b,c,d,e){var f=this;this.view="events",this.selecting={background:!1,object:!1,entity:!1},this.selectedObject=null,this.selectedEntity=null,this.selectedEvent=null,this.selectBackground=function(a){e.getAssetInfo(a.id,"backgrounds").done(function(b){a.info=b,c.editor.currentScene.background=angular.copy(a),f.selecting.background=!1,c.$apply()})},this.selectObject=function(a){a&&e.getAssetInfo(a.id,"obstacles").done(function(b){a.info=b,c.editor.currentScene.objects.push(angular.copy(a)),f.selecting.object=!1})},this.selectEntity=function(a){a&&e.getAssetInfo(a.id,"entities").done(function(b){a.info=b,c.editor.currentScene.entities.push(angular.copy(a)),f.selecting.entity=!1})},this.selectEvent=function(a){a&&c.editor.currentScene.events.push(angular.copy(a))},this.alreadyAdded=function(a){return!!c.editor.currentScene&&c.editor.currentScene.events.forEach(function(b){return a.id===b.id})},this.removeEvent=function(a){c.editor.currentScene.events.splice(a,1)},this.addLocationEvent=function(){var a=c.editor.currentScene.events.filter(function(a){return"location"===a.category}).length;console.log("LocationCount: ",a);var b=a>=1?"New Location Event "+a:"New Location Event",d={name:b,category:"location",info:{requirements:[],results:{achievements:[],inventory:[],portal:{},text:[]},triggers:[]}};console.log("newEvent: ",d),c.editor.currentScene.events.push(d)},this.anyResults=function(a){if(!a)return!1;var b=a.info.results;return b.text.length>0||b.achievements.length>0||b.inventory.length>0||Object.keys(b.portal).length>0},this.anyRequirements=function(a){if(!a)return!1;0===a.info.requirements.length&&(a.info.requirements={achievements:[],inventory:[]});var b=a.info.requirements;return b.achievements.length>0||b.inventory.length>0},this.removeAsset=function(a,b){c.editor.currentScene[b].splice(a,1)},this.saveScene=function(a){console.log("Turns out saving is unnecessary here. Here's the game as proof."),console.log(c.editor.currentEditingGame)},this.placeAsset=function(a,b){console.log("placin");var e=a.thumbnail,f='<img src="'+e+'" draggable">',g=angular.element(f),h=d(g),i=h(c);$(i).appendTo("#scene-BG"),c.apply}});var headerData,testData,testData,testData,testData;